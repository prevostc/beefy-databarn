version: 2

models:
  - name: account
    description: "Dimension table for account (address) reference data. Provides a unified reference for all addresses in the system with labels identifying their roles (products, strategies, tokens, smart contracts)."
    config:
      contract:
        enforced: true
      meta:
        primary_key: "address"
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - address
      - dbt_utils.expression_is_true:
          arguments:
            expression: "(first_activity_timestamp is null or first_activity_timestamp > '2000-01-01') and (last_activity_timestamp is null or last_activity_timestamp > '2000-01-01')"
    columns:
      - name: address
        description: "Account address (normalized EVM address). Primary key."
        data_type: String
        tests:
          - not_null
          - unique
      - name: labels
        description: "Array of labels identifying the address type(s). Possible values include: clm_manager, clm_strategy, classic_vault, classic_vault_strategy, classic_boost, reward_pool, token, smart_contract, zero_address. An address can have multiple labels."
        data_type: Array(String)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: "is not null and length(labels) >= 0"
      - name: is_contract
        description: "Whether the address is a contract. True if the address is any product type (vault, boost, reward pool) or strategy, or if indicated as a contract in address_metadata."
        data_type: Bool
        tests:
          - not_null
      - name: active_chain_ids
        description: "Array of chain IDs where this address has been seen (from reference data) or has recorded activity (from token balance changes). Empty array if address has not been seen on any chain."
        data_type: Array(Int64)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: "is not null and length(active_chain_ids) > 0"
          - relationships_array:
              arguments:
                to: ref('chain')
                to_column: chain_id
      - name: first_activity_timestamp
        description: "Timestamp of the first token balance change for this address. Null if the address has no recorded activity."
        data_type: Nullable(DateTime64(3, 'UTC'))
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "is null or first_activity_timestamp > '2000-01-01'"
      - name: last_activity_timestamp
        description: "Timestamp of the most recent token balance change for this address. Null if the address has no recorded activity."
        data_type: Nullable(DateTime64(3, 'UTC'))
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "is null or last_activity_timestamp > '2000-01-01'"
      - name: total_balance_changes
        description: "Total number of token balance changes recorded for this address. 0 if the address has no recorded activity."
        data_type: UInt64
        tests:
          - not_null
      - name: unique_transactions
        description: "Number of distinct transactions that resulted in balance changes for this address. 0 if the address has no recorded activity."
        data_type: UInt64
        tests:
          - not_null
      - name: unique_tokens
        description: "Number of distinct tokens involved in balance changes for this address. 0 if the address has no recorded activity."
        data_type: UInt64
        tests:
          - not_null

