version: 2

models:
  - name: yield_harvest_events
    description: "Transform harvest events into yield structure. Maps harvest events to a yield model, where underlying_amount_compounded * underlying_token_price_usd represents yield."
    config:
      contract:
        enforced: true
      meta:
        primary_key:
          ["chain_id", "block_number", "tx_idx", "event_idx", "tx_hash"]
    tests:
      - relationships_multi_key:
          name: relationships_product_address_product
          arguments:
            to: ref('product')
            from_columns: ["chain_id", "product_address"]
            to_columns: ["chain_id", "product_address"]
    columns:
      - name: chain_id
        description: "Chain ID where the harvest occurred (foreign key to chain.chain_id)"
        data_type: Int64
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('chain')
                field: chain_id
      - name: chain_name
        description: "Chain name"
        data_type: String
        tests:
          - not_null
      - name: block_number
        description: "Block number where the harvest event occurred"
        data_type: Int64
        tests:
          - not_null
      - name: date_time
        description: "Timestamp of the harvest event"
        data_type: DateTime('UTC')
        tests:
          - not_null
      - name: tx_idx
        description: "Transaction index within the block"
        data_type: Int32
        tests:
          - not_null
      - name: event_idx
        description: "Index of the event within the transaction"
        data_type: Int32
        tests:
          - not_null
      - name: tx_hash
        description: "Transaction hash of the harvest"
        data_type: String
        tests:
          - not_null
      - name: product_address
        description: "Product address (foreign key to product.product_address)"
        data_type: String
        tests:
          - not_null
      - name: underlying_amount_compounded
        description: "Amount harvested"
        data_type: Decimal(76, 20)
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                inclusive: false
      - name: underlying_token_price_usd
        description: "Price of the want token at the time of harvest in USD"
        data_type: Decimal(76, 20)
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                inclusive: false
      - name: underlying_amount_compounded_usd
        description: "Yield amount in USD (underlying_amount_compounded * underlying_token_price_usd)"
        data_type: Decimal(76, 20)
        tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                inclusive: false
